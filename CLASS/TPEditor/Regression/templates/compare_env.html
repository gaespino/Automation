{% extends "base.html" %}
{% block title %}Env File Comparison{% endblock %}
{% block content %}

<div class="section-header d-flex justify-content-between align-items-center">
  <h5><i class="bi bi-file-earmark-text me-2"></i>Environment File – HDST_PAT_PATH Comparison</h5>
  <button class="btn btn-sm btn-primary" onclick="applySelected('env')">
    <i class="bi bi-check2-all me-1"></i>Apply Selected
  </button>
</div>

{% if result.ref_error %}
<div class="alert alert-danger"><b>Ref Error:</b> {{ result.ref_error }}</div>
{% endif %}
{% if result.new_error %}
<div class="alert alert-warning"><b>New Error:</b> {{ result.new_error }}</div>
{% endif %}

<!-- Summary badges -->
<div class="mb-3 d-flex gap-2">
  <span class="badge bg-danger">{{ result.only_in_ref|length }} only in Ref</span>
  <span class="badge bg-success">{{ result.only_in_new|length }} only in New</span>
  <span class="badge bg-secondary">{{ result.in_both|length }} in both</span>
</div>

<!-- Two-column header with truncated paths -->
{% set ref_short = resolved.ref_env_file | replace(cfg.ref_tp_path, '') | replace('\\', ' ▸ ') | trim(' ▸ ') %}
{% set new_short = resolved.new_env_file | replace(cfg.new_tp_path, '') | replace('\\', ' ▸ ') | trim(' ▸ ') %}
<div class="diff-header row g-0">
  <div class="col-1"></div>
  <div class="col-1 text-center"><input type="checkbox" id="selectAllEnv" onchange="toggleAll('env',this.checked)"/></div>
  <div class="col-5 px-2 fw-bold ref-label" title="{{ resolved.ref_env_file }}">
    <small class="text-muted">REF</small> {{ ref_short }}
  </div>
  <div class="col-5 px-2 fw-bold new-label" title="{{ resolved.new_env_file }}">
    <small class="text-muted">NEW</small> {{ new_short }}
  </div>
</div>

<!-- Only in Ref (migrate candidates) -->
{% for entry in result.only_in_ref %}
<div class="diff-row diff-ref-only row g-0 align-items-center"
     data-type="{{ entry.type }}">
  <div class="col-1 text-center">
    <span class="badge type-badge {{ entry.type | lower }}">{{ entry.type[:3] }}</span>
  </div>
  <div class="col-1 text-center">
    <input type="checkbox" class="env-check" name="env_action"
           data-action='{"type":"add_env_path","path_entry":"{{ entry.path | e }}"}' />
  </div>
  <div class="col-5 px-2 font-mono diff-value">{{ entry.path }}</div>
  <div class="col-5 px-2 text-muted fst-italic">— missing —</div>
</div>
{% endfor %}

<!-- Only in New -->
{% for entry in result.only_in_new %}
<div class="diff-row diff-new-only row g-0 align-items-center">
  <div class="col-1 text-center">
    <span class="badge type-badge {{ entry.type | lower }}">{{ entry.type[:3] }}</span>
  </div>
  <div class="col-1"></div>
  <div class="col-5 px-2 text-muted fst-italic">— missing —</div>
  <div class="col-5 px-2 font-mono diff-value">{{ entry.path }}</div>
</div>
{% endfor %}

<!-- In Both (collapsed by default) -->
<details class="mt-3">
  <summary class="text-muted small cursor-pointer">
    Show {{ result.in_both|length }} identical entries
  </summary>
  {% for entry in result.in_both %}
  <div class="diff-row diff-identical row g-0 align-items-center">
    <div class="col-1 text-center">
      <span class="badge type-badge {{ entry.type | lower }}">{{ entry.type[:3] }}</span>
    </div>
    <div class="col-1"></div>
    <div class="col-5 px-2 font-mono diff-value text-muted">{{ entry.path }}</div>
    <div class="col-5 px-2 font-mono diff-value text-muted">{{ entry.path }}</div>
  </div>
  {% endfor %}
</details>

{% endblock %}
